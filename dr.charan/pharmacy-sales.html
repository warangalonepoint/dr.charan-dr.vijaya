<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy Sales — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .list{max-height:420px;overflow:auto}
    .row{padding:.5rem;border-bottom:1px solid var(--ring);display:flex;justify-content:space-between;gap:8px;align-items:center;cursor:pointer}
    .row:hover{background:rgba(255,255,255,.04)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .smallmuted{font-size:.85rem;color:var(--muted)}
    .cart{max-height:300px;overflow:auto}
    .qty{width:5.5rem}
    .paygrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:720px){.paygrid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Banner CARD -->
  <div class="hero-card">
    <img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic">
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <h2 style="margin-top:0">Pharmacy — Sales</h2>
      <div class="grid">
        <!-- Left: Items & quick add -->
        <div class="page-card">
          <h3 style="margin-top:0">Items</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input id="q" class="in" placeholder="Search or add (name | sku | mrp)" style="flex:1">
            <button class="btn" id="addItemBtn">Add/Update Item</button>
          </div>
          <div class="list" id="items"></div>
        </div>

        <!-- Right: Cart + Checkout -->
        <div class="page-card">
          <h3 style="margin-top:0">Cart</h3>
          <div class="cart" id="cart"></div>

          <div style="height:8px"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <div class="smallmuted">Party/PID (optional)</div>
            <input id="party" class="in mono" placeholder="PID / Name" style="max-width:260px">
          </div>

          <div style="height:12px"></div>
          <div class="page-card" style="padding:12px">
            <h3 style="margin:0 0 10px">Checkout</h3>
            <div class="paygrid">
              <div>
                <label class="small">Payment Mode</label>
                <select id="payMode" class="in sel">
                  <option value="cash">Cash</option>
                  <option value="upi">UPI</option>
                  <option value="card">Card</option>
                </select>
              </div>
              <div>
                <label class="small">Reference (UPI Txn / Card last4)</label>
                <input id="payRef" class="in mono" placeholder="Optional reference">
              </div>
            </div>
            <div style="height:8px"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;flex-wrap:wrap">
              <div class="pill">Total: <strong id="total">₹0.00</strong></div>
              <button class="btn" id="clearBtn">Clear</button>
              <button class="btn primary" id="billBtn">Save Bill</button>
            </div>
            <div class="smallmuted" id="msg" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>
  <script src="./scripts/data-wire.js"></script>
  <script src="./scripts/notifications.js"></script>

  <script type="module">
    import db from './scripts/db.js';
    import { emitClinicChange } from './scripts/data-wire.js';

    // Theme + housekeeping
    const html=document.documentElement, saved=localStorage.getItem('theme')||'dark';
    html.setAttribute('data-theme',saved);
    document.getElementById('themeBtn').onclick=()=>{const n=html.getAttribute('data-theme')==='dark'?'light':'dark';html.setAttribute('data-theme',n);localStorage.setItem('theme',n);};
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{ if(!confirm('Clear caches + DB?')) return; if('caches' in window){ const n=await caches.keys(); for(const k of n) await caches.delete(k);} localStorage.clear(); location.reload(); };

    const E=id=>document.getElementById(id);
    const money=v=>'₹'+Number(v||0).toFixed(2);
    const todayISO=()=>new Date().toISOString().slice(0,10);

    const msg=E('msg');

    // ---------- Items ----------
    const itemsEl=E('items'), q=E('q');

    async function upsertItemFromQuery(){
      const s=q.value.trim(); if(!s) return;
      // Parse "name | sku | mrp" → e.g., "Zincovit | ZCV01 | 120"
      let name=s, sku='', mrp=0;
      if(s.includes('|')){
        const [n,k,m]=s.split('|').map(x=>x.trim());
        name=n||s; sku=k||''; mrp=Number(m||0);
      }
      // find by sku or by name
      let it=null;
      if(sku) it = await db.pharmacyItems.where('sku').equals(sku).first();
      if(!it)  it = await db.pharmacyItems.where('name').equals(name).first();
      if(it){
        await db.pharmacyItems.update(it.id,{ name, sku:sku||it.sku||'', mrp: mrp||it.mrp||0 });
      }else{
        await db.pharmacyItems.add({ name, sku: sku||null, mrp: Number(mrp||0), stock: 0, barcode:null });
      }
      q.value='';
      renderItems();
    }

    async function renderItems(){
      const s=(q.value||'').toLowerCase();
      let rows = await db.pharmacyItems.toArray();
      if(s){
        rows = rows.filter(r=>{
          const hay=[r.name,r.sku,r.barcode].map(x=>(x||'').toLowerCase()).join('|');
          return hay.includes(s);
        });
      }
      rows.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      itemsEl.innerHTML='';
      rows.forEach(it=>{
        const div=document.createElement('div');
        div.className='row';
        div.innerHTML=`<div>
          <strong>${it.name||''}</strong> <span class="smallmuted">${it.sku||''}</span>
          <div class="smallmuted mono">MRP: ${money(it.mrp||0)} • Stock: ${it.stock||0}</div>
        </div>
        <div><button class="btn" data-id="${it.id}">Add</button></div>`;
        div.querySelector('button').onclick=()=>addToCart(it);
        itemsEl.appendChild(div);
      });
    }

    q.addEventListener('keydown',e=>{ if(e.key==='Enter') upsertItemFromQuery(); });
    document.getElementById('addItemBtn').onclick=upsertItemFromQuery;

    // ---------- Cart ----------
    const cartEl=E('cart'), totalEl=E('total'), partyEl=E('party'), payModeEl=E('payMode'), payRefEl=E('payRef');
    let cart=[]; // {itemId,name,sku,qty,price}

    function refreshTotal(){
      const t = cart.reduce((s,l)=> s + (Number(l.qty||0)*Number(l.price||0)), 0);
      totalEl.textContent = money(t);
      return t;
    }

    function renderCart(){
      cartEl.innerHTML='';
      if(!cart.length){ cartEl.innerHTML='<div class="smallmuted">Cart is empty.</div>'; totalEl.textContent=money(0); return; }
      cart.forEach((line,idx)=>{
        const row=document.createElement('div');
        row.className='row';
        row.innerHTML=`
          <div>
            <strong>${line.name}</strong> <span class="smallmuted">${line.sku||''}</span>
            <div class="smallmuted mono">₹/unit: ${Number(line.price||0).toFixed(2)}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <input type="number" class="in qty mono" value="${line.qty}" min="-999" step="1" data-k="qty">
            <input type="number" class="in qty mono" value="${line.price}" min="0" step=".01" data-k="price">
            <button class="btn" data-act="del">X</button>
          </div>`;
        const [qtyIn, priceIn] = row.querySelectorAll('input');
        qtyIn.onchange=()=>{ line.qty = Number(qtyIn.value||0); refreshTotal(); };
        priceIn.onchange=()=>{ line.price = Number(priceIn.value||0); refreshTotal(); };
        row.querySelector('[data-act="del"]').onclick=()=>{ cart.splice(idx,1); renderCart(); };
        cartEl.appendChild(row);
      });
      refreshTotal();
    }

    function addToCart(it){
      cart.push({ itemId: it.id, name: it.name, sku: it.sku, qty: 1, price: Number(it.mrp||0) });
      renderCart();
    }

    E('clearBtn').onclick=()=>{ cart=[]; renderCart(); msg.textContent=''; };

    // ---------- Save Bill + Receipt (payment) ----------
    async function saveBill(){
      msg.textContent='';
      if(cart.length===0){ alert('Cart is empty'); return; }
      const date=todayISO();
      const total=refreshTotal();
      const type='sale';

      // Create invoice
      const invoiceId = await db.invoices.add({ date, type, total, party: partyEl.value||null });

      // Save items & update stock
      for(const line of cart){
        await db.invoiceItems.add({
          invoiceId, sku: line.sku||null, name: line.name, qty: Number(line.qty||0), price: Number(line.price||0), party: partyEl.value||null
        });
        const it = await db.pharmacyItems.get(line.itemId);
        if(it){
          const newStock = Number(it.stock||0) - Number(line.qty||0);
          await db.pharmacyItems.update(it.id,{ stock: newStock });
        }
      }

      // Record payment as a voucher (receipt) WITHOUT schema changes
      const mode = payModeEl.value;          // 'cash' | 'upi' | 'card'
      const ref  = (payRefEl.value||'').trim();
      const note = `invoice:${invoiceId}; mode:${mode}${ref?'; ref:'+ref:''}`;
      await db.vouchers.add({ date, type:'receipt', amount: total, party: partyEl.value||null, note });

      // Notify doctor (optional)
      try{ if(window.notifyDoctor){ window.notifyDoctor({title:'Pharmacy sale', body:`Bill #${invoiceId} • ${money(total)} (${mode})`, tag:'pharmacy'});} }catch{}

      // Emit bus & reset UI
      emitClinicChange('pharmacy:sale',{invoiceId,date,total,mode});
      cart=[]; renderCart(); partyEl.value=''; payRefEl.value=''; payModeEl.value='cash';
      msg.textContent = `Saved bill #${invoiceId} with ${mode.toUpperCase()} payment${ref?(' (ref: '+ref+')'):''}.`;
      alert('Saved bill #' + invoiceId);
    }

    E('billBtn').onclick = saveBill;

    // Init
    renderItems();
    renderCart();
  </script>
</body>
</html>