<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lab Orders — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .list{max-height:420px;overflow:auto}
    .row{padding:.55rem;border-bottom:1px solid var(--ring);display:flex;justify-content:space-between;gap:8px;align-items:center;cursor:pointer}
    .row:hover{background:rgba(255,255,255,.04)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .smallmuted{font-size:.85rem;color:var(--muted)}
    .cart{max-height:340px;overflow:auto}
    .qty{width:5.5rem}
    .pill span{margin-left:.4rem}
  </style>
</head>
<body>
  <!-- Banner CARD -->
  <div class="hero-card">
    <img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic">
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <h2 style="margin:0 0 6px">Lab Orders</h2>
      <div class="small">Pick patient, add tests, and save an order. Totals roll up into <span class="mono">labInvoices</span>.</div>

      <div style="height:12px"></div>

      <div class="grid">
        <!-- LEFT: tests & patient search -->
        <div class="page-card">
          <h3 style="margin-top:0">Patient</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input id="pSearch" class="in" placeholder="Find patient (phone / PID / name)" style="flex:1">
            <button class="btn" id="pClear">Clear</button>
          </div>
          <div id="pPick" class="list" style="margin-top:8px;max-height:180px;overflow:auto"></div>
          <div style="height:8px"></div>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div><label class="small">Patient ID</label><input id="patientId" class="in mono" placeholder="PID / Phone"></div>
            <div><label class="small">Patient Name</label><input id="patientName" class="in" placeholder="Child Name"></div>
          </div>

          <div style="height:18px"></div>
          <h3 style="margin:0">Tests</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input id="q" class="in" placeholder="Search tests (name / code / barcode)" style="flex:1">
            <button class="btn" id="addCustom">Add Custom</button>
          </div>
          <div class="list" id="tests"></div>
        </div>

        <!-- RIGHT: cart & checkout -->
        <div class="page-card">
          <h3 style="margin-top:0">Order</h3>
          <div class="cart" id="cart"></div>

          <div style="height:8px"></div>
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
            <span class="pill">Tests: <span id="kCount">0</span></span>
            <span class="pill">Total: <span id="kTotal">₹0.00</span></span>
          </div>

          <div style="height:10px"></div>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div>
              <label class="small">Date</label>
              <input id="date" type="date" class="in mono">
            </div>
            <div>
              <label class="small">Note</label>
              <input id="note" class="in" placeholder="Optional remarks">
            </div>
          </div>

          <div style="height:10px"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" id="clearBtn">Clear</button>
            <button class="btn primary" id="saveBtn">Save Order</button>
          </div>
          <div class="smallmuted" id="msg" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Vendor -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>

  <!-- App scripts -->
  <script src="./scripts/data-wire.js"></script>
  <script src="./scripts/notifications.js"></script>

  <script type="module">
    import db from './scripts/db.js';
    import { emitClinicChange } from './scripts/data-wire.js';

    // Theme + housekeeping
    const html=document.documentElement, saved=localStorage.getItem('theme')||'dark';
    html.setAttribute('data-theme',saved);
    document.getElementById('themeBtn').onclick=()=>{const n=html.getAttribute('data-theme')==='dark'?'light':'dark';html.setAttribute('data-theme',n);localStorage.setItem('theme',n)};
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{ if(!confirm('Clear caches + DB?')) return; if('caches' in window){ const n=await caches.keys(); for(const k of n) await caches.delete(k);} localStorage.clear(); location.reload(); };

    const E=id=>document.getElementById(id);
    const money=v=>'₹'+Number(v||0).toFixed(2);
    const today=()=>new Date().toISOString().slice(0,10);

    // Date default
    E('date').value = today();

    // ---------- Patient search & pick ----------
    const pSearch=E('pSearch'), pPick=E('pPick'), pId=E('patientId'), pName=E('patientName');
    E('pClear').onclick=()=>{ pId.value=''; pName.value=''; pSearch.value=''; pPick.innerHTML=''; };

    pSearch.addEventListener('input', renderPatientSearch);

    async function renderPatientSearch(){
      const s=(pSearch.value||'').toLowerCase().trim();
      if(!s){ pPick.innerHTML=''; return; }
      let rows = await db.patients.toArray();
      rows = rows.filter(p=>{
        const hay=[p.phone,p.pid,p.name].map(x=>(x||'').toLowerCase()).join('|');
        return hay.includes(s);
      }).slice(0,100);
      rows.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
      pPick.innerHTML='';
      rows.forEach(p=>{
        const div=document.createElement('div'); div.className='row';
        div.innerHTML = `<div>
          <strong>${p.name||''}</strong> <span class="smallmuted">(${p.phone||''})</span>
          <div class="smallmuted mono">${p.pid||''}</div>
        </div>
        <div><button class="btn">Select</button></div>`;
        div.querySelector('button').onclick=()=>{
          pId.value = p.pid || p.phone || '';
          pName.value = p.name || '';
        };
        pPick.appendChild(div);
      });
    }

    // ---------- Tests list ----------
    const testsEl=E('tests'), q=E('q');

    async function renderTests(){
      const s=(q.value||'').toLowerCase().trim();
      let rows = await db.labTests.toArray();
      if(s){
        rows = rows.filter(t=>{
          const hay=[t.name,t.code,t.barcode].map(x=>(x||'').toLowerCase()).join('|');
          return hay.includes(s);
        });
      }
      rows.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
      testsEl.innerHTML='';
      rows.forEach(t=>{
        const div=document.createElement('div'); div.className='row';
        div.innerHTML = `<div>
            <strong>${t.name||''}</strong> <span class="smallmuted">${t.code||''}</span>
            <div class="smallmuted mono">₹${Number(t.price||0).toFixed(2)}</div>
          </div>
          <div><button class="btn">Add</button></div>`;
        div.querySelector('button').onclick=()=>addToCart({ code:t.code, name:t.name, price:Number(t.price||0) });
        testsEl.appendChild(div);
      });
    }
    q.addEventListener('input', renderTests);

    // Add custom (ad-hoc) test
    E('addCustom').onclick=()=>{
      const name = prompt('Custom test name?'); if(!name) return;
      const price = Number(prompt('Price?')||0);
      addToCart({ code:null, name, price:isNaN(price)?0:price });
    };

    // ---------- Cart ----------
    const cartEl=E('cart'), kCount=E('kCount'), kTotal=E('kTotal'), msg=E('msg');
    let cart=[]; // {code,name,price,qty}

    function refreshBadges(){
      const total = cart.reduce((s,l)=> s + Number(l.qty||0)*Number(l.price||0), 0);
      const count = cart.reduce((s,l)=> s + Number(l.qty||0), 0);
      kCount.textContent = count;
      kTotal.textContent = money(total);
      return {count,total};
    }

    function renderCart(){
      cartEl.innerHTML='';
      if(!cart.length){ cartEl.innerHTML='<div class="smallmuted">No tests added.</div>'; refreshBadges(); return; }
      cart.forEach((l,i)=>{
        const row=document.createElement('div'); row.className='row';
        row.innerHTML = `
          <div>
            <strong>${l.name}</strong> <span class="smallmuted">${l.code||''}</span>
            <div class="smallmuted mono">₹/test: ${Number(l.price||0).toFixed(2)}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <input type="number" class="in qty mono" value="${l.qty}" min="1" step="1">
            <input type="number" class="in qty mono" value="${l.price}" min="0" step=".01">
            <button class="btn">X</button>
          </div>`;
        const [qtyIn,priceIn,delBtn]=row.querySelectorAll('input,button');
        qtyIn.onchange=()=>{ l.qty=Number(qtyIn.value||0)||1; refreshBadges(); };
        priceIn.onchange=()=>{ l.price=Number(priceIn.value||0)||0; refreshBadges(); };
        delBtn.onclick=()=>{ cart.splice(i,1); renderCart(); };
        cartEl.appendChild(row);
      });
      refreshBadges();
    }

    function addToCart(t){
      cart.push({ code:t.code||null, name:t.name, price:Number(t.price||0)||0, qty:1 });
      renderCart();
    }

    E('clearBtn').onclick=()=>{ cart=[]; renderCart(); msg.textContent=''; };

    // ---------- Save Order ----------
    E('saveBtn').onclick=async()=>{
      msg.textContent='';
      if(!pId.value || !pName.value){ alert('Select or enter patient details.'); return; }
      if(cart.length===0){ alert('Add at least one test.'); return; }
      const {total} = refreshBadges();
      const date = E('date').value || today();

      // Save to labInvoices (schema: ++id, date, patientId, patientName, amount)
      const id = await db.labInvoices.add({
        date, patientId: pId.value, patientName: pName.value, amount: Number(total||0)
      });

      // MVP notification for doctor
      try{
        if(window.notifyDoctor){
          window.notifyDoctor({ title:`New lab order: ${pId.value}`, body:`₹${Number(total).toFixed(2)} — ${pName.value}`, tag:'lab' });
        }
      }catch{}

      // Emit bus
      emitClinicChange('lab:order',{invoiceId:id,date,total});

      // Reset
      cart=[]; renderCart();
      E('note').value='';
      msg.textContent = `Saved lab order #${id} for ${pName.value}.`;
      alert('Saved lab order #'+id);
    };

    // Init
    renderTests();
  </script>
</body>
</html>