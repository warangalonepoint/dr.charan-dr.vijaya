<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Patients Registry — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .list{max-height:520px;overflow:auto}
    .row{padding:.6rem;border-bottom:1px solid var(--ring);cursor:pointer}
    .row:hover{background:rgba(255,255,255,.04)}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <!-- Banner CARD -->
  <div class="hero-card">
    <img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic">
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <h2 style="margin-top:0">Patients Registry</h2>
      <p class="small">Create or update patient profiles. Front office and doctor can edit; supervisor read-only.</p>
      <div class="grid">
        <!-- Form -->
        <div class="page-card">
          <h3 style="margin-top:0">Details</h3>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div><label class="small">PID</label><input id="pid" class="in mono" placeholder="PID (optional)"></div>
            <div><label class="small">Barcode</label><input id="barcode" class="in mono" placeholder="Scan/Enter"></div>
            <div><label class="small">Phone*</label><input id="phone" class="in mono" placeholder="10-digit"></div>
            <div><label class="small">Parent/Guardian</label><input id="parent" class="in" placeholder="Parent"></div>
            <div><label class="small">Child Name*</label><input id="name" class="in" placeholder="Name"></div>
            <div><label class="small">DOB</label><input id="dob" type="date" class="in"></div>
            <div><label class="small">Height (cm)</label><input id="height" class="in mono" placeholder="cm"></div>
            <div><label class="small">Weight (kg)</label><input id="weight" class="in mono" placeholder="kg"></div>
          </div>
          <div style="height:8px"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" id="newBtn">New</button>
            <button class="btn primary" id="saveBtn">Save</button>
          </div>
          <div class="small muted" id="msg" style="margin-top:8px"></div>
        </div>

        <!-- List -->
        <div class="page-card">
          <h3 style="margin-top:0">Find Patients</h3>
          <input id="q" class="in" placeholder="Search by phone / name / PID / barcode">
          <div class="list" id="list"></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>
  <script src="./scripts/data-wire.js"></script>
  <script type="module">
    import db from './scripts/db.js';
    import { emitClinicChange } from './scripts/data-wire.js';

    // Role guard: doctor/frontoffice edit, supervisor read-only
    const role=localStorage.getItem('role')||'doctor';
    const readOnly = (role==='supervisor');

    // Theme + housekeeping
    const html=document.documentElement, saved=localStorage.getItem('theme')||'dark';
    html.setAttribute('data-theme',saved);
    document.getElementById('themeBtn').onclick=()=>{const n=html.getAttribute('data-theme')==='dark'?'light':'dark';html.setAttribute('data-theme',n);localStorage.setItem('theme',n);};
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{ if(!confirm('Clear caches + DB?')) return; if('caches' in window){ const n=await caches.keys(); for(const k of n) await caches.delete(k);} localStorage.clear(); location.reload(); };

    const E=id=>document.getElementById(id);
    const msg=E('msg');
    const controls=['pid','barcode','phone','parent','name','dob','height','weight'].map(E);

    if(readOnly){
      controls.forEach(el=>el.setAttribute('disabled',''));
      document.getElementById('saveBtn').style.display='none';
      msg.textContent='Read-only mode (Supervisor).';
    }

    function formData(){
      return {
        pid:E('pid').value.trim()||null,
        barcode:E('barcode').value.trim()||null,
        phone:E('phone').value.trim(),
        name:E('name').value.trim(),
        parent:E('parent').value.trim()||null,
        dob:E('dob').value||null,
        heightCm:Number(E('height').value||0)||null,
        weightKg:Number(E('weight').value||0)||null,
      };
    }
    function setForm(p){
      E('pid').value=p?.pid||'';
      E('barcode').value=p?.barcode||'';
      E('phone').value=p?.phone||'';
      E('parent').value=p?.parent||'';
      E('name').value=p?.name||'';
      E('dob').value=p?.dob||'';
      E('height').value=p?.heightCm||'';
      E('weight').value=p?.weightKg||'';
    }
    function clearForm(){ setForm({}); msg.textContent=''; }

    E('newBtn').onclick=clearForm;

    async function save(){
      if(readOnly) return;
      const p=formData();
      if(!p.phone || !p.name){ msg.textContent='Phone and Child Name are required.'; return; }

      // Duplicate by phone?
      const dupe = await db.patients.where('phone').equals(p.phone).first();
      let id=null;
      if(dupe){
        if(!confirm('A patient with this phone exists. Overwrite?')){ msg.textContent='Cancelled'; return; }
        id=dupe.id;
        await db.patients.update(id,{...p, updatedAt:Date.now()});
      }else{
        id = await db.patients.add({...p, createdAt:Date.now(), updatedAt:Date.now()});
      }
      msg.textContent='Saved.';
      emitClinicChange('patients:changed',{id,phone:p.phone});
      renderList();
    }
    document.getElementById('saveBtn').onclick=save;

    // List/search
    const list=E('list'), q=E('q');
    q.addEventListener('input',renderList);

    async function renderList(){
      const s=(q.value||'').toLowerCase();
      let rows = await db.patients.toArray();
      if(s){
        rows = rows.filter(p=>{
          const hay=[p.phone,p.name,p.pid,p.barcode].map(x=>(x||'').toString().toLowerCase()).join('|');
          return hay.includes(s);
        });
      }
      rows.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      list.innerHTML='';
      rows.forEach(p=>{
        const div=document.createElement('div');
        div.className='row';
        div.innerHTML=`<div><strong>${p.name||''}</strong> <span class="muted">(${p.phone||''})</span></div>
                       <div class="small mono">${p.pid||''} ${p.barcode?('• '+p.barcode):''}</div>`;
        div.onclick=()=>setForm(p);
        list.appendChild(div);
      });
    }

    renderList();
  </script>
</body>
</html>
