<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Analytics — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:1100px){.charts{grid-template-columns:1fr}}
    .chart-card{background:var(--card);border:1px solid var(--ring);border-radius:var(--card-radius);box-shadow:var(--shadow);padding:12px}
    canvas{width:100%;height:320px}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
    .badge{display:flex;flex-direction:column;align-items:center;gap:4px;background:var(--card);border:1px solid var(--ring);border-radius:var(--card-radius);padding:10px}
    .badge .n{font-size:1.8rem;font-weight:900}
  </style>
</head>
<body>
  <!-- Banner CARD -->
  <div class="hero-card"><img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic"></div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <h2 style="margin:0 0 6px">Global Analytics</h2>
      <div class="small">Trends computed locally from IndexedDB (offline-first).</div>

      <!-- KPIs -->
      <div class="kpi">
        <div class="badge"><div class="small">Bookings Today</div><div class="n" id="kBookings">0</div></div>
        <div class="badge"><div class="small">Approved Today</div><div class="n" id="kApproved">0</div></div>
        <div class="badge"><div class="small">Done Today</div><div class="n" id="kDone">0</div></div>
        <div class="badge"><div class="small">Pharmacy Revenue (₹) Today</div><div class="n" id="kRev">0</div></div>
        <div class="badge"><div class="small">Lab Orders Today</div><div class="n" id="kLab">0</div></div>
      </div>
    </div>

    <div style="height:12px"></div>

    <!-- Charts -->
    <div class="charts">
      <div class="chart-card">
        <h3 style="margin:0 0 6px">Bookings — last 14 days</h3>
        <canvas id="bookingsLine"></canvas>
      </div>
      <div class="chart-card">
        <h3 style="margin:0 0 6px">Revenue mix (Pharmacy vs Lab) — last 14 days</h3>
        <canvas id="revenuePie"></canvas>
      </div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Vendor -->
  <script src="./vendor/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>

  <!-- App -->
  <script type="module">
    import db from './scripts/db.js';
    import { onClinicChange } from './scripts/data-wire.js';

    // Theme / housekeeping
    const html=document.documentElement, saved=localStorage.getItem('theme')||'dark';
    html.setAttribute('data-theme',saved);
    themeBtn.onclick=()=>{const n=html.getAttribute('data-theme')==='dark'?'light':'dark';html.setAttribute('data-theme',n);localStorage.setItem('theme',n)};
    clearCacheBtn.onclick=async()=>{ if(!confirm('Clear caches + DB?')) return; if('caches'in window){const ns=await caches.keys(); for(const n of ns) await caches.delete(n);} await db.delete(); const keep=localStorage.getItem('theme'); localStorage.clear(); if(keep) localStorage.setItem('theme',keep); location.reload(); };
    logoutBtn.onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };

    const E=id=>document.getElementById(id);
    const today=()=>new Date().toISOString().slice(0,10);
    const money=n=>'₹'+Number(n||0).toFixed(0);

    // KPIs (today)
    async function refreshKPIs(){
      const d=today();
      const appts = await db.appointments.where('date').equals(d).toArray();
      E('kBookings').textContent = appts.length;
      E('kApproved').textContent = appts.filter(a=>a.status==='approved').length;
      E('kDone').textContent = appts.filter(a=>a.status==='done').length;

      const inv = await db.invoices.where('date').equals(d).toArray();
      const pharm= inv.filter(i=>i.type==='sale').reduce((s,i)=>s+Number(i.total||0),0);
      E('kRev').textContent = money(pharm);

      const labs = await db.labInvoices.where('date').equals(d).toArray();
      E('kLab').textContent = labs.length;
    }

    // Helpers: last 14 dates
    function lastNDates(n){
      const arr=[]; const t=new Date();
      for(let i=n-1;i>=0;i--){
        const d=new Date(t); d.setDate(t.getDate()-i);
        arr.push(d.toISOString().slice(0,10));
      }
      return arr;
    }

    async function seriesBookings(days){
      const out=[];
      for(const d of days){
        const c = await db.appointments.where('date').equals(d).count();
        out.push(c);
      }
      return out;
    }
    async function totalsRevenue(days){
      let pharm=0, lab=0;
      for(const d of days){
        const inv = await db.invoices.where('date').equals(d).toArray();
        pharm += inv.filter(i=>i.type==='sale').reduce((s,i)=>s+Number(i.total||0),0);
        const labs = await db.labInvoices.where('date').equals(d).toArray();
        lab += labs.reduce((s,i)=>s+Number(i.amount||0),0);
      }
      return {pharm, lab};
    }

    // Charts
    let lineChart, pieChart;
    async function renderCharts(){
      const days = lastNDates(14);
      const lineData = await seriesBookings(days);
      const ctx1 = document.getElementById('bookingsLine').getContext('2d');
      if(lineChart) lineChart.destroy();
      lineChart = new Chart(ctx1,{
        type:'line',
        data:{ labels:days.map(d=>d.slice(5)), datasets:[{ label:'Bookings', data:lineData, tension:.35, fill:false }]},
        options:{ responsive:true, plugins:{ legend:{display:false} } }
      });

      const {pharm, lab} = await totalsRevenue(days);
      const ctx2 = document.getElementById('revenuePie').getContext('2d');
      if(pieChart) pieChart.destroy();
      pieChart = new Chart(ctx2,{
        type:'pie',
        data:{ labels:['Pharmacy','Lab'], datasets:[{ data:[pharm,lab] }]},
        options:{ responsive:true, plugins:{ legend:{position:'bottom'} } }
      });
    }

    async function refreshAll(){ 
      await refreshKPIs(); 
      await renderCharts(); 
    }

    // Initial load
    await refreshAll();

    // Live refresh on pulses (seeding, clearing, cross-tab events)
    onClinicChange(()=>refreshAll());

    // Also refresh when user switches back to this tab
    document.addEventListener('visibilitychange', ()=>{
      if(!document.hidden) refreshAll();
    });

    // Safety net: refresh every 15s
    setInterval(refreshAll, 15000);
  </script>
</body>
</html>