<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy Expiry — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .rowCard{border:1px solid var(--ring);border-radius:14px;padding:.65rem .8rem;margin:.35rem 0;background:var(--card);display:grid;grid-template-columns:120px 1fr 110px 120px 1fr 130px;gap:10px;align-items:center}
    @media (max-width:980px){ .rowCard{grid-template-columns:1fr} }
    .warn{color:var(--warn)}
  </style>
</head>
<body>
  <!-- Banner CARD (locked on all pages) -->
  <div class="hero-card">
    <img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic">
  </div>

  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:0 0 6px">Pharmacy — Expiry / Write-off</h2>
          <p class="small" style="margin:0">
            Decrease stock for expired/damaged items. Each write-off is logged as a <code>vouchers</code> entry
            (<code>type:'journal'</code>, <code>party:'expiry'</code>, <code>amount:0</code>) for audit and reports.
          </p>
        </div>
        <span class="pill">Today: <span id="todayStr"></span></span>
      </div>

      <!-- Write-off form -->
      <div class="card" style="margin-bottom:12px">
        <h3 style="margin:0 0 8px">New Write-off</h3>
        <div class="grid">
          <input id="scan" class="in mono" placeholder="Scan / type barcode or SKU">
          <input id="search" class="in" placeholder="Search item name">
          <input id="sku" class="in mono" placeholder="SKU (auto)"/>
          <input id="name" class="in" placeholder="Item name (auto)"/>
          <input id="stock" class="in" type="number" min="0" placeholder="Current stock" disabled>
          <input id="qty" class="in" type="number" min="1" value="1" placeholder="Qty to write-off">
          <input id="expDate" class="in" type="date" placeholder="Expiry date (optional)">
          <input id="reason" class="in" placeholder="Reason (e.g., expired, damaged)">
        </div>
        <div style="height:8px"></div>
        <div class="row">
          <button class="btn" id="btnPick">Pick Item</button>
          <button class="btn primary" id="btnWriteoff">Apply Write-off</button>
          <button class="btn" id="btnNew">New</button>
          <span class="small warn" id="msg"></span>
        </div>
      </div>

      <!-- Audit / history -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <h3 style="margin:0">Write-off Log</h3>
            <input id="from" class="in" type="date" style="max-width:160px">
            <input id="to" class="in" type="date" style="max-width:160px">
          </div>
          <div class="row">
            <input id="q" class="in" style="max-width:260px" placeholder="Search SKU / name / reason">
            <button class="btn" id="btnRun">Run</button>
            <button class="btn" id="btnCsv">CSV</button>
            <button class="btn" id="btnPrint">Print</button>
          </div>
        </div>

        <div id="list"></div>
      </div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Vendor -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>

  <!-- App scripts -->
  <script src="./scripts/utils.js"></script>
  <script src="./scripts/sw-update.js"></script>
  <script src="./scripts/data-wire.js"></script>
  <script src="./scripts/auth.js"></script>

  <script type="module">
    import './scripts/db.js';

    // ---------- shell ----------
    const html=document.documentElement;
    const saved=localStorage.getItem('theme')||'dark'; html.setAttribute('data-theme',saved);
    document.getElementById('themeBtn')?.addEventListener('click',()=>{ const n=html.getAttribute('data-theme')==='dark'?'light':'dark'; html.setAttribute('data-theme',n); localStorage.setItem('theme',n); });
    document.getElementById('clearCacheBtn')?.addEventListener('click', async ()=>{
      if(!confirm('Clear all app caches and local DB?')) return;
      if('caches' in window){ const names=await caches.keys(); for(const n of names) await caches.delete(n); }
      await db.delete();
      const keep=localStorage.getItem('theme'); localStorage.clear(); if(keep) localStorage.setItem('theme',keep);
      alert('Cleared. Reloading…'); location.reload();
    });
    document.getElementById('logoutBtn')?.addEventListener('click',()=>{ localStorage.removeItem('role'); location.href='./login.html'; });
    document.getElementById('todayStr').textContent = new Date().toISOString().slice(0,10);

    // ---------- elems ----------
    const E=id=>document.getElementById(id);

    // Date defaults for log: this month
    const d=new Date(); const first=new Date(d.getFullYear(),d.getMonth(),1).toISOString().slice(0,10);
    const last =new Date(d.getFullYear(),d.getMonth()+1,0).toISOString().slice(0,10);
    E('from').value=first; E('to').value=last;

    // Pick by scan/SKU/name
    E('btnPick').onclick = pickItem;
    E('search').addEventListener('input', debounce(fillSuggest, 150));
    async function fillSuggest(){
      const q=(E('search').value||'').toLowerCase();
      if(!q) return;
      const rows=(await db.pharmacyItems.toArray()).filter(r=>(r.name||'').toLowerCase().includes(q)).slice(0,8);
      if(rows[0]) useItem(rows[0]);
    }

    async function pickItem(){
      const code=(E('scan').value||'').trim();
      const bySku = await db.pharmacyItems.where('sku').equals(code).first();
      const byBc  = await db.pharmacyItems.where('barcode').equals(code).first();
      const r = bySku || byBc;
      if(!r){ E('msg').textContent='Item not found (try search)'; setTimeout(()=>E('msg').textContent='',1200); return; }
      useItem(r);
    }

    function useItem(r){
      E('sku').value=r.sku||''; E('name').value=r.name||''; E('stock').value=Number(r.stock||0);
      if(Number(E('qty').value||1) > Number(E('stock').value||0)) E('qty').value = String(Math.max(1, Number(E('stock').value||0)));
    }

    // Apply write-off
    E('btnWriteoff').onclick = async ()=>{
      const sku=(E('sku').value||'').trim(); if(!sku) return alert('Pick an item first');
      const qty=Math.max(1, Number(E('qty').value||1));
      const reason=(E('reason').value||'').trim() || 'expired';
      const exp=(E('expDate').value||'');
      const row = await db.pharmacyItems.where('sku').equals(sku).first();
      if(!row) return alert('Item not found');
      const cur=Number(row.stock||0);
      if(qty>cur) return alert('Qty exceeds current stock');
      await db.pharmacyItems.update(row.id, { stock: cur - qty });

      // Audit to vouchers as a zero-amount journal with party='expiry'
      const note = `SKU:${row.sku} • NAME:${row.name||''} • QTY:${qty} • EXP:${exp||'-'} • REASON:${reason}`;
      await db.vouchers.add({
        date: new Date().toISOString().slice(0,10),
        type: 'journal',
        amount: 0,
        party: 'expiry',
        note
      });

      emitClinicChange('pharmacy:inventory', { sku, qty });
      E('msg').textContent = 'Write-off applied';
      setTimeout(()=> E('msg').textContent='', 1200);

      // reset minimal
      ['scan','qty','reason','expDate'].forEach(id=> E(id).value='');
      E('qty').value='1';
      useItem(await db.pharmacyItems.get(row.id)); // refresh stock field
      await run(); // refresh log
    };

    E('btnNew').onclick = ()=>{ ['scan','search','sku','name','stock','qty','reason','expDate'].forEach(id=> E(id).value=''); E('qty').value='1'; };

    // ---------- Log (reads vouchers where party==='expiry') ----------
    E('btnRun').onclick = run;
    E('q').addEventListener('input', ()=> setTimeout(run, 120));

    async function run(){
      const from=E('from').value||'0000-01-01';
      const to=E('to').value||'9999-12-31';
      const q=(E('q').value||'').toLowerCase();
      let rows = await db.vouchers.where('party').equals('expiry').toArray();
      rows = rows.filter(r=> (r.date||'')>=from && (r.date||'')<=to);
      // Parse structured note back into fields
      const parsed = rows.map(r=>{
        const obj = { date:r.date||'', id:r.id||0, type:r.type, note:r.note||'' };
        const m = (r.note||'').split('•').reduce((acc,seg)=>{
          const [k,...rest]=seg.trim().split(':'); acc[k?.trim()?.toLowerCase()||'note']=rest.join(':').trim(); return acc;
        }, {});
        return {
          ...obj,
          sku: m['sku']||'',
          name: m['name']||'',
          qty: Number(m['qty']||0),
          exp: m['exp']||'',
          reason: m['reason']||''
        };
      });
      let list=parsed;
      if(q){
        list = parsed.filter(x=>
          (x.sku||'').toLowerCase().includes(q) ||
          (x.name||'').toLowerCase().includes(q) ||
          (x.reason||'').toLowerCase().includes(q));
      }
      list.sort((a,b)=> (a.date||'').localeCompare(b.date||'') || (a.id||0)-(b.id||0));

      const box=document.getElementById('list'); box.innerHTML='';
      if(!list.length){ box.innerHTML='<p class="small">No write-offs in the selected period.</p>'; return; }

      list.forEach(r=>{
        const div=document.createElement('div'); div.className='rowCard';
        div.innerHTML = `
          <div>${r.date||'—'}</div>
          <div><strong>${r.name||'—'}</strong><div class="small mono">${r.sku||''}</div></div>
          <div class="mono">Qty: ${r.qty||0}</div>
          <div class="small">Expiry: ${r.exp||'—'}</div>
          <div class="small">Reason: ${r.reason||'—'}</div>
          <div class="small mono">#${r.id}</div>
        `;
        box.appendChild(div);
      });
    }

    // CSV + Print
    document.getElementById('btnCsv').onclick = ()=>{
      const cards=[...document.querySelectorAll('#list .rowCard')];
      const rows=[['Date','SKU','Name','Qty','Expiry','Reason','ID']];
      cards.forEach(c=>{
        const t=[...c.children].map(x=>x.textContent.trim());
        rows.push([t[0], t[1].split('\n')[1]||'', t[1].split('\n')[0]||'', (t[2].replace('Qty:','').trim()), t[3].replace('Expiry:','').trim(), t[4].replace('Reason:','').trim(), t[5].replace('#','').trim()]);
      });
      const csv=rows.map(r=>r.join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='expiry-writeoffs.csv'; a.click(); URL.revokeObjectURL(a.href);
    };

    document.getElementById('btnPrint').onclick = ()=>{
      const html = `<h2>Expiry / Write-off Log</h2><div>${document.getElementById('list').innerHTML}</div>`;
      printWithHeader('Expiry Write-offs', html);
    };

    // Utils
    function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)};}

    await run();
    onClinicChange((e)=>{ if(e?.evt==='pharmacy:inventory' || e?.evt==='import:done'){ run(); } });
  </script>
</body>
</html>