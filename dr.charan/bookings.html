<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bookings — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .grid{display:grid;gap:10px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.four{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px){.grid.two,.grid.three,.grid.four{grid-template-columns:1fr}}
    .subtle{opacity:.85}
    .section-title{margin:0 0 6px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hint{opacity:.7;font-size:.85rem}
  </style>
</head>
<body>
  <!-- Banner (shared) -->
  <div class="hero-card">
    <img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic">
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0 0 6px">Front Office Bookings</h2>
          <div class="small subtle">Generate slots, capture patient info, create bookings (pending), and send WhatsApp confirmations.</div>
        </div>
        <span class="pill">Today: <span id="todayStr"></span></span>
      </div>

      <!-- DATE -->
      <div style="height:10px"></div>
      <div class="grid two">
        <label>Date
          <input type="date" id="dateInput" class="in"/>
        </label>
        <div>
          <div class="small subtle" style="margin-bottom:6px">Quick</div>
          <div class="inline">
            <button class="btn" id="loadTodayBtn">Load Today</button>
            <button class="btn" id="clearSlotsBtn">Clear Day’s Slots</button>
          </div>
        </div>
      </div>

      <!-- SLOT GENERATOR (Custom) -->
      <div style="height:14px"></div>
      <h3 class="section-title">Generate Custom Time Slots</h3>
      <div class="small subtle" style="margin:0 0 8px">Configure AM/PM windows & interval (mins). Generates fresh slots for selected date.</div>

      <div class="grid three">
        <div class="card">
          <div class="small subtle" style="margin-bottom:6px">Morning window</div>
          <div class="grid three">
            <label>Start
              <input id="amStart" class="in" type="time" value="09:00">
            </label>
            <label>End
              <input id="amEnd" class="in" type="time" value="12:00">
            </label>
            <label>Interval (mins)
              <input id="amStep" class="in" type="number" min="5" step="5" value="30">
            </label>
          </div>
        </div>

        <div class="card">
          <div class="small subtle" style="margin-bottom:6px">Afternoon window</div>
          <div class="grid three">
            <label>Start
              <input id="pmStart" class="in" type="time" value="14:00">
            </label>
            <label>End
              <input id="pmEnd" class="in" type="time" value="17:00">
            </label>
            <label>Interval (mins)
              <input id="pmStep" class="in" type="number" min="5" step="5" value="30">
            </label>
          </div>
        </div>

        <div class="card">
          <div class="small subtle" style="margin-bottom:6px">Actions</div>
          <div class="grid two">
            <button class="btn primary" id="genSlotsBtn">Generate Slots</button>
            <button class="btn" id="reloadSlotsBtn">Reload Slots</button>
          </div>
          <div class="small subtle" id="slotCount" style="margin-top:8px">0 slots</div>
        </div>
      </div>

      <!-- BOOKING FORM -->
      <div style="height:14px"></div>
      <h3 class="section-title">Assign Booking</h3>

      <div class="grid two">
        <label>Available Slot
          <select id="slotSelect" class="sel"></select>
        </label>
        <label>Source
          <div class="inline">
            <select id="source" class="sel">
              <option value="walk-in">Walk-in</option>
              <option value="online">Online</option>
              <option value="whatsapp">WhatsApp</option>
            </select>
            <button class="btn" id="waBtn" title="Open WhatsApp with confirmation" style="display:none">WhatsApp Message</button>
          </div>
          <span class="hint">Use the WhatsApp button when Source = WhatsApp. It composes a message using phone + reason.</span>
        </label>
      </div>

      <div class="grid four" style="margin-top:8px">
        <label>PID (optional; auto if blank)
          <input id="pid" class="in" placeholder="Pxxx">
        </label>
        <label>Child Name *
          <input id="name" class="in" placeholder="Child full name" required>
        </label>
        <label>Phone
          <input id="phone" class="in" placeholder="10-digit">
        </label>
        <label>Parent
          <input id="parent" class="in" placeholder="Parent / Guardian">
        </label>
      </div>

      <div class="grid four" style="margin-top:8px">
        <label>DOB
          <input id="dob" class="in" type="date">
        </label>
        <label>Age (auto)
          <input id="age" class="in" placeholder="Years" disabled>
        </label>
        <label>Height (cm)
          <input id="height" class="in" type="number" min="0" step="0.1" placeholder="e.g., 95">
        </label>
        <label>Weight (kg)
          <input id="weight" class="in" type="number" min="0" step="0.1" placeholder="e.g., 14">
        </label>
      </div>

      <div class="grid two" style="margin-top:8px">
        <label>Reason
          <input id="reason" class="in" placeholder="Reason for visit">
        </label>
        <div style="align-self:end" class="inline">
          <button class="btn primary" id="saveBtn">Save Booking</button>
        </div>
      </div>

      <!-- TODAY'S BOOKINGS -->
      <div style="height:18px"></div>
      <h3 class="section-title">Bookings for selected day</h3>
      <table class="tbl">
        <thead><tr><th>Token</th><th>Time</th><th>PID</th><th>Name</th><th>Phone</th><th>Source</th><th>Status</th></tr></thead>
        <tbody id="todayTable"></tbody>
      </table>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Dexie & App -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>
  <script type="module">
    import db from './scripts/db.js';
    import { emitClinicChange, onClinicChange } from './scripts/data-wire.js';

    // ===== Helpers =====
    const E = id => document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const pad = n => String(n).padStart(2,'0');
    const to12h = (hhmm) => {
      const [h,m] = hhmm.split(':').map(Number);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${pad(h12)}:${pad(m)} ${ampm}`;
    };
    const minutesBetween = (start, end) => {
      const [hs, ms] = start.split(':').map(Number);
      const [he, me] = end.split(':').map(Number);
      return (he*60+me) - (hs*60+ms);
    };
    const addMinutes = (hhmm, step) => {
      const [h,m] = hhmm.split(':').map(Number);
      const t = h*60 + m + step;
      const nh = Math.floor(t/60), nm = t%60;
      return `${pad(nh)}:${pad(nm)}`;
    };
    const calcAge = (dobStr) => {
      if(!dobStr) return '';
      const d = new Date(dobStr);
      if(isNaN(d)) return '';
      const now = new Date();
      let y = now.getFullYear() - d.getFullYear();
      const m = now.getMonth() - d.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < d.getDate())) y--;
      return y;
    };
    const onlyDigits = (s='') => s.replace(/\D+/g,'');
    const enc = (s='') => encodeURIComponent(s);

    let clinicName = 'Dr. Charan Child Clinic';
    (async ()=>{ try{ const meta = await db.clinic.get('meta'); if(meta?.name) clinicName = meta.name; }catch{} })();

    // ===== Init =====
    E('todayStr').textContent = todayISO();
    E('dateInput').value = todayISO();

    // Age auto
    E('dob').addEventListener('change', ()=>{ E('age').value = calcAge(E('dob').value) || ''; });

    // Toggle WhatsApp button
    function updateWhatsAppButton(){
      const show = E('source').value === 'whatsapp';
      E('waBtn').style.display = show ? 'inline-flex' : 'none';
    }
    E('source').addEventListener('change', updateWhatsAppButton);
    updateWhatsAppButton();

    // ===== Slots =====
    function buildWindowSlots(date, start, end, step){
      const slots = [];
      if(!start || !end || step<=0) return slots;
      if(minutesBetween(start,end) <= 0) return slots;
      let t = start;
      while (minutesBetween(t, end) > 0){
        slots.push({ date, time: to12h(t) });
        t = addMinutes(t, step);
      }
      return slots;
    }

    async function generateSlotsForDay(date){
      await db.slots.where('date').equals(date).delete();
      let token = 1;
      const am = buildWindowSlots(date, E('amStart').value, E('amEnd').value, Number(E('amStep').value||0));
      const pm = buildWindowSlots(date, E('pmStart').value, E('pmEnd').value, Number(E('pmStep').value||0));
      const all = [...am, ...pm].map((s,idx)=>({
        ...s,
        key: `${s.date}-${s.time}`,
        status: 'free',
        token: token + idx
      }));
      if(all.length) await db.slots.bulkAdd(all);
      E('slotCount').textContent = `${all.length} slots`;
      emitClinicChange({evt:'slots:generated', payload:{date}});
    }

    async function loadSlots(date){
      const rows = await db.slots.where('date').equals(date).toArray();
      const free = rows.filter(s=>s.status==='free');
      E('slotSelect').innerHTML = free.map(s=>`<option value="${s.id}">${s.time} (#${s.token})</option>`).join('');
      E('slotCount').textContent = `${rows.length} slots (${free.length} free)`;
    }

    async function loadDayBookings(date){
      const list = await db.appointments.where('date').equals(date).toArray();
      list.sort((a,b)=> (a.token||0)-(b.token||0));
      E('todayTable').innerHTML = list.map(a=>`
        <tr>
          <td>${a.token||''}</td>
          <td>${a.time||''}</td>
          <td>${a.pid||''}</td>
          <td>${a.name||''}</td>
          <td>${a.phone||''}</td>
          <td>${a.source||''}</td>
          <td>${a.status||''}</td>
        </tr>
      `).join('');
    }

    // ===== Patient upsert =====
    async function ensurePatient({pid, phone, name, parent, dob, height, weight}){
      let finalPid = (pid||'').trim();
      if(finalPid){
        const ex = await db.patients.where('pid').equals(finalPid).first();
        if(ex){
          await db.patients.update(ex.id, {
            phone: phone||ex.phone,
            name: name||ex.name,
            parent: parent||ex.parent,
            dob: dob||ex.dob,
            heightCm: height||ex.heightCm,
            weightKg: weight||ex.weightKg,
            updatedAt: Date.now()
          });
        }else{
          await db.patients.add({
            pid: finalPid, phone, name, parent, dob,
            heightCm: height||null, weightKg: weight||null,
            createdAt: Date.now(), updatedAt: Date.now()
          });
        }
      }else{
        finalPid = 'P' + Date.now().toString().slice(-6);
        await db.patients.add({
          pid: finalPid, phone, name, parent, dob,
          heightCm: height||null, weightKg: weight||null,
          createdAt: Date.now(), updatedAt: Date.now()
        });
      }
      return finalPid;
    }

    // ===== WhatsApp deep-link =====
    function buildWhatsAppLink({phone, name, date, time, token, reason, pid}){
      const cleanPhone = onlyDigits(phone||'');
      if(!cleanPhone) return null;

      const lines = [
        `Hello ${name||'there'},`,
        `Your booking at ${clinicName} is noted.`,
        `Date: ${date||''}`,
        `Time: ${time||''}${token?` (Token #${token})`:''}`,
        pid ? `PID: ${pid}` : null,
        reason ? `Reason: ${reason}` : null,
        `— Thank you`
      ].filter(Boolean);

      const msg = lines.join('\n');
      return `https://wa.me/${cleanPhone}?text=${enc(msg)}`;
    }

    E('waBtn').addEventListener('click', async ()=>{
      // use current form values (before or after saving)
      const sid = Number(E('slotSelect').value);
      const slot = sid ? await db.slots.get(sid) : null;
      const link = buildWhatsAppLink({
        phone:  E('phone').value.trim(),
        name:   E('name').value.trim() || 'Patient',
        date:   E('dateInput').value || todayISO(),
        time:   slot?.time || '',
        token:  slot?.token || '',
        reason: E('reason').value.trim(),
        pid:    (E('pid').value||'').trim()
      });
      if(!link) { alert('Enter a valid phone number for WhatsApp.'); return; }
      window.open(link, '_blank', 'noopener,noreferrer');
    });

    // ===== Booking save =====
    async function saveBooking(){
      const sid = Number(E('slotSelect').value);
      const slot = sid ? await db.slots.get(sid) : null;
      if(!slot){ alert('Select a free slot'); return; }

      const name   = E('name').value.trim();
      if(!name){ alert('Child name is required'); return; }

      // gather optional fields
      const pidIn  = E('pid').value.trim();
      const phone  = E('phone').value.trim();
      const parent = E('parent').value.trim();
      const dob    = E('dob').value || null;
      const height = E('height').value ? Number(E('height').value) : null;
      const weight = E('weight').value ? Number(E('weight').value) : null;
      const source = E('source').value;
      const reason = E('reason').value.trim();

      // upsert patient & get PID
      const pid = await ensurePatient({pid:pidIn, phone, name, parent, dob, height, weight});

      // appointment
      await db.appointments.add({
        date: slot.date,
        time: slot.time,
        pid, name, phone,
        token: slot.token,
        status: 'pending',
        source,
        reason,
        createdAt: Date.now()
      });

      // mark slot booked
      await db.slots.update(sid, { status:'booked', pid, name, phone });

      // history entry
      await db.patientHistory.add({
        pid,
        date: slot.date,
        note: `Booking created for ${slot.time} (token #${slot.token}) • Source: ${source}${reason?` • ${reason}`:''}`,
        author: 'Front Office',
        meta: { type:'booking' }
      });

      // live updates
      emitClinicChange({evt:'appointments:changed', payload:{date:slot.date}});
      await loadSlots(slot.date);
      await loadDayBookings(slot.date);

      // If source is WhatsApp, offer to open message now
      if(source === 'whatsapp'){
        const link = buildWhatsAppLink({
          phone, name, date:slot.date, time:slot.time, token:slot.token, reason, pid
        });
        if(link && confirm('Open WhatsApp to send confirmation?')) {
          window.open(link, '_blank', 'noopener,noreferrer');
        }
      }

      alert('Booking saved.');
      E('reason').value='';
    }

    // ===== Wire UI =====
    E('genSlotsBtn').onclick = async ()=>{
      const d = E('dateInput').value || todayISO();
      await generateSlotsForDay(d);
      await loadSlots(d);
      await loadDayBookings(d);
    };
    E('reloadSlotsBtn').onclick = async ()=>{
      const d = E('dateInput').value || todayISO();
      await loadSlots(d); await loadDayBookings(d);
    };
    E('clearSlotsBtn').onclick = async ()=>{
      const d = E('dateInput').value || todayISO();
      if(!confirm(`Clear ALL slots for ${d}?`)) return;
      await db.slots.where('date').equals(d).delete();
      await loadSlots(d); await loadDayBookings(d);
      emitClinicChange({evt:'slots:generated', payload:{date:d}});
    };
    E('loadTodayBtn').onclick = async ()=>{
      E('dateInput').value = todayISO();
      await loadSlots(todayISO());
      await loadDayBookings(todayISO());
    };

    E('saveBtn').onclick = saveBooking;
    E('dateInput').onchange = async ()=>{
      const d = E('dateInput').value || todayISO();
      await loadSlots(d); await loadDayBookings(d);
    };

    // initial load
    (async ()=>{
      const d = E('dateInput').value || todayISO();
      await loadSlots(d);
      await loadDayBookings(d);
    })();

    onClinicChange((ev)=>{
      if(!ev) return;
      const d = E('dateInput').value || todayISO();
      if(ev.evt && (ev.evt.startsWith('appointments') || ev.evt.startsWith('slots'))){
        loadDayBookings(d);
        loadSlots(d);
      }
    });

    // Topbar
    (function wireTopbar(){
      const html=document.documentElement;
      const saved=localStorage.getItem('theme')||'dark';
      html.setAttribute('data-theme',saved);
      document.getElementById('themeBtn').onclick=()=>{
        const n=html.getAttribute('data-theme')==='dark'?'light':'dark';
        html.setAttribute('data-theme',n); localStorage.setItem('theme',n);
      };
      document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };
      document.getElementById('clearCacheBtn').onclick=async()=>{
        if(!confirm('Clear caches + DB?')) return;
        if('caches' in window){ const names=await caches.keys(); for(const n of names) await caches.delete(n); }
        await db.delete();
        const keep=localStorage.getItem('theme'); localStorage.clear(); if(keep) localStorage.setItem('theme',keep);
        location.reload();
      };
    })();
  </script>
</body>
</html>
