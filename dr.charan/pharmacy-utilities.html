<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy Utilities — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
</head>
<body>
  <!-- Banner -->
  <div class="hero-card"><img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic"></div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <h2>Pharmacy Utilities</h2>
      <p class="small">Manage stock adjustments, expiry, and seeding for testing.</p>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <button class="btn" id="seedPharmBtn">Seed Pharmacy Data</button>
        <button class="btn" id="clearPharmBtn" style="background:var(--bad);color:#fff;border:0">Clear Pharmacy Data</button>
      </div>

      <!-- Stock Adjust -->
      <h3>Stock Adjustment</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
        <input class="in" id="adjSku" placeholder="SKU (e.g. SEED-PARA-250)">
        <input class="in" id="adjQty" type="number" placeholder="Quantity ±">
        <button class="btn primary" id="adjBtn">Adjust</button>
      </div>

      <!-- Expiry Write-off -->
      <h3>Mark Expiry / Write-off</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
        <input class="in" id="expSku" placeholder="SKU">
        <input class="in" id="expQty" type="number" placeholder="Quantity">
        <button class="btn primary" id="expBtn">Write-off</button>
      </div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Dexie + db + pharmacy seed -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>
  <script src="./scripts/db.js"></script>
  <script src="./scripts/pharmacy-seed.js"></script>

  <script>
    // Theme toggle
    const html=document.documentElement;
    html.setAttribute('data-theme',localStorage.getItem('theme')||'dark');
    document.getElementById('themeBtn').onclick=()=>{
      const n=html.getAttribute('data-theme')==='dark'?'light':'dark';
      html.setAttribute('data-theme',n); localStorage.setItem('theme',n);
    };
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      if(!confirm('Clear caches+DB?')) return;
      if('caches' in window){ const names=await caches.keys(); for(const n of names) await caches.delete(n); }
      await db.delete(); const keep=localStorage.getItem('theme'); localStorage.clear();
      if(keep) localStorage.setItem('theme',keep); location.reload();
    };

    // Seed/Clear buttons
    document.getElementById('seedPharmBtn').onclick=async()=>{ 
      await window.seedPharmacyData(); alert('Pharmacy data seeded.');
    };
    document.getElementById('clearPharmBtn').onclick=async()=>{ 
      await window.clearPharmacyData(); alert('Pharmacy data cleared.');
    };

    // Stock adjustment
    document.getElementById('adjBtn').onclick=async()=>{
      const sku=document.getElementById('adjSku').value.trim();
      const qty=parseInt(document.getElementById('adjQty').value,10)||0;
      if(!sku||!qty) return alert('Enter SKU and quantity');
      const item=await db.pharmacyItems.where('sku').equals(sku).first();
      if(!item) return alert('Item not found: '+sku);
      await db.pharmacyItems.update(item.id,{stock:(item.stock||0)+qty});
      alert(`Adjusted ${sku} by ${qty}. New stock=${(item.stock||0)+qty}`);
    };

    // Expiry / write-off
    document.getElementById('expBtn').onclick=async()=>{
      const sku=document.getElementById('expSku').value.trim();
      const qty=parseInt(document.getElementById('expQty').value,10)||0;
      if(!sku||!qty) return alert('Enter SKU and quantity');
      const item=await db.pharmacyItems.where('sku').equals(sku).first();
      if(!item) return alert('Item not found: '+sku);
      const newStock=Math.max(0,(item.stock||0)-qty);
      await db.pharmacyItems.update(item.id,{stock:newStock});
      await db.invoices.add({
        date:new Date().toISOString().slice(0,10),
        type:'expiry',
        total:0, pid:null, party:'Expiry Write-off', supplier:null,
        bill:'EXP-'+Date.now()
      });
      alert(`Expired ${qty} units of ${sku}. Stock now=${newStock}`);
    };
  </script>
</body>
</html>